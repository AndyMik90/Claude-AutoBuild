name: PR Status Gate

on:
  workflow_run:
    workflows: [CI, Lint, Quality Security, Quality DCO, Quality Commit Lint]
    types: [completed]

permissions:
  pull-requests: write
  actions: read

jobs:
  update-status:
    name: Update PR Status
    if: github.event.workflow_run.pull_requests[0]
    runs-on: ubuntu-latest
    steps:
      - name: Check all workflows and update label
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.workflow_run.pull_requests[0].number;
            const headSha = context.payload.workflow_run.head_sha;
            const required = [
              { name: 'CI', file: 'ci.yml' },
              { name: 'Lint', file: 'lint.yml' },
              { name: 'Quality Security', file: 'quality-security.yml' },
              { name: 'Quality DCO', file: 'quality-dco.yml' },
              { name: 'Quality Commit Lint', file: 'quality-commit-lint.yml' }
            ];
            const labels = {
              checking: 'üîÑ Checking',
              passed: '‚úÖ Ready for Review',
              failed: '‚ùå Checks Failed'
            };

            console.log(`Checking workflows for PR #${prNumber} (SHA: ${headSha})`);

            let allComplete = true;
            let anyFailed = false;

            for (const workflow of required) {
              try {
                const { data } = await github.rest.actions.listWorkflowRuns({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: workflow.file,
                  head_sha: headSha,
                  per_page: 1
                });

                if (!data.workflow_runs.length) {
                  console.log(`${workflow.name}: No runs found yet`);
                  allComplete = false;
                  continue;
                }

                const run = data.workflow_runs[0];
                console.log(`${workflow.name}: status=${run.status}, conclusion=${run.conclusion}`);

                if (run.status !== 'completed') {
                  allComplete = false;
                } else if (run.conclusion !== 'success') {
                  anyFailed = true;
                }
              } catch (error) {
                console.log(`${workflow.name}: Error checking - ${error.message}`);
                allComplete = false;
              }
            }

            if (!allComplete) {
              console.log('Not all workflows complete yet, skipping label update');
              return;
            }

            // Remove old status labels
            for (const label of Object.values(labels)) {
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  name: label
                });
              } catch (e) {
                // Label doesn't exist, ignore
              }
            }

            // Add final status label
            const newLabel = anyFailed ? labels.failed : labels.passed;
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: [newLabel]
            });

            console.log(`Updated PR #${prNumber} with label: ${newLabel}`);
