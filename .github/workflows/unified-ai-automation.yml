name: Unified AI Automation Pipeline

# MASTER WORKFLOW: CodeRabbit â†’ Copilot â†’ OpenHands
# Complete automation from issue to merged PR

on:
  issues:
    types: [opened, labeled]
  issue_comment:
    types: [created]
  pull_request_target:
    types: [opened, synchronize, ready_for_review]
  schedule:
    - cron: '0 * * * *'  # Hourly backup
  workflow_dispatch:
    inputs:
      action:
        description: 'Manual action'
        type: choice
        options: [check-all, assign-copilot-all, trigger-openhands-all]

permissions:
  issues: write
  contents: write
  pull-requests: write

env:
  GH_TOKEN: ${{ secrets.COPILOT_PAT || secrets.GITHUB_TOKEN }}

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 1: CodeRabbit Planning
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  new-issue-request-plan:
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'
    steps:
      - name: Request CodeRabbit plan
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.issue.number;
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue,
              labels: ['auto-implement', 'needs-plan', 'stage-1-planning']
            });
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue,
              body: [
                '## ðŸ¤– Automation Pipeline Started',
                '',
                '@coderabbitai Please create a comprehensive implementation plan:',
                '',
                '1. **Requirements Analysis**',
                '2. **Implementation Steps**',
                '3. **Files to Modify/Create**',
                '4. **Test Cases**',
                '5. **Acceptance Criteria**',
                '',
                '_Copilot will be auto-assigned when plan is ready._'
              ].join('\n')
            });

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 2: Copilot Assignment
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  detect-plan-assign-copilot:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request == null &&
      contains(github.event.comment.user.login, 'coderabbitai')
    steps:
      - name: Check plan completion
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body;
            const planIndicators = ['## Implementation', '## Coding Plan', '### Phase', 'Prompt for AI'];
            const hasPlan = planIndicators.some(i => comment.includes(i));
            const ready = hasPlan && comment.length > 500 && !comment.includes('in progress');

            if (!ready) {
              core.setOutput('ready', 'false');
              return;
            }

            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const labels = issue.data.labels.map(l => l.name);
            if (labels.includes('copilot-assigned')) {
              core.setOutput('ready', 'false');
              return;
            }

            core.setOutput('ready', 'true');
            core.setOutput('issue_number', context.issue.number);

      - name: Assign Copilot via API
        if: steps.check.outputs.ready == 'true'
        env:
          GH_TOKEN: ${{ secrets.COPILOT_PAT || secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM="${{ steps.check.outputs.issue_number }}"
          echo "Assigning Copilot to issue #$ISSUE_NUM"

          # Try copilot-swe-agent (official)
          gh api repos/${{ github.repository }}/issues/$ISSUE_NUM/assignees \
            -X POST -f 'assignees[]=copilot-swe-agent' 2>&1 || \
          gh api repos/${{ github.repository }}/issues/$ISSUE_NUM/assignees \
            -X POST -f 'assignees[]=Copilot' 2>&1 || true

          gh issue edit $ISSUE_NUM \
            --add-label "copilot-assigned,stage-2-implementation,in-progress" \
            --remove-label "needs-plan,stage-1-planning" 2>&1 || true

      - name: Request implementation
        if: steps.check.outputs.ready == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const num = ${{ steps.check.outputs.issue_number }};
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: num,
              body: [
                '## ðŸš€ Plan Ready - Copilot Assigned',
                '',
                '@copilot Please implement following the plan above:',
                '- Follow plan exactly',
                '- Include unit tests',
                '- Add error handling',
                '- Create PR with `Fixes #' + num + '`',
                '',
                '_If no PR in 4 hours, @openhands-agent takes over._'
              ].join('\n')
            });

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 3: PR Automation
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  pr-request-review:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request_target' &&
      (github.event.action == 'opened' || github.event.action == 'ready_for_review')
    steps:
      - name: Request CodeRabbit review
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: ['needs-review', 'auto-merge-ready']
            });
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: '@coderabbitai Review thoroughly: code quality, tests, security, performance.'
            });

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # MANUAL TRIGGERS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  manual-copilot-all:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'assign-copilot-all'
    steps:
      - uses: actions/github-script@v7
        id: issues
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });
            const eligible = issues.data
              .filter(i => !i.pull_request)
              .filter(i => !i.labels.some(l => l.name === 'copilot-assigned'))
              .slice(0, 30)
              .map(i => i.number);
            core.setOutput('issues', eligible.join(','));

      - if: steps.issues.outputs.issues != ''
        env:
          GH_TOKEN: ${{ secrets.COPILOT_PAT || secrets.GITHUB_TOKEN }}
        run: |
          IFS=',' read -ra ISSUES <<< "${{ steps.issues.outputs.issues }}"
          for ISSUE_NUM in "${ISSUES[@]}"; do
            gh api repos/${{ github.repository }}/issues/$ISSUE_NUM/assignees \
              -X POST -f 'assignees[]=copilot-swe-agent' 2>&1 || true
            gh issue edit $ISSUE_NUM --add-label "copilot-assigned" 2>&1 || true
            sleep 0.5
          done

  manual-openhands-all:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'trigger-openhands-all'
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });
            for (const issue of issues.data.filter(i => !i.pull_request)) {
              if (!issue.labels.some(l => l.name === 'fix-me')) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: ['fix-me']
                });
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: '@openhands-agent Implement this issue with tests.'
                });
              }
            }
